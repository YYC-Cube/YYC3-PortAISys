# YYC³ PortAISys - 文档同步机制使用说明文档

## 文档信息

**文档名称**: 文档同步机制使用说明文档  
**文档版本**: v1.0  
**创建日期**: 2026-01-20  
**最后更新**: 2026-01-20  
**文档状态**: ✅ 已完成  
**负责团队**: 技术架构团队  
**负责人**: 技术架构师  

---

## 一、快速开始

### 1.1 安装与初始化

**步骤1: 进入工具目录**
```bash
cd tools/doc-code-sync
```

**步骤2: 运行初始化脚本**
```bash
./init.sh
```

初始化脚本会自动完成以下操作：
- 检查 Node.js 版本（要求 18.0.0 或更高）
- 安装项目依赖
- 构建项目
- 初始化文档同步配置

**步骤3: 验证安装**
```bash
# 查看帮助信息
node dist/index.js --help

# 或全局安装后
yyc3-doc-sync --help
```

### 1.2 启动监控

**方式1: 使用启动脚本**
```bash
./start.sh
```

**方式2: 使用命令行工具**
```bash
node dist/index.js watch

# 或全局安装后
yyc3-doc-sync watch
```

**方式3: 指定参数**
```bash
node dist/index.js watch --docs-dir docs --code-dir core
```

启动监控后，工具会：
- 监控文档目录（默认: docs）和代码目录（默认: core）的文件变更
- 自动触发同步操作
- 实时显示同步结果
- 发送异常告警通知

**停止监控**: 按 `Ctrl+C` 停止监控

---

## 二、详细使用指南

### 2.1 初始化配置

**命令**:
```bash
node dist/index.js init [options]
```

**选项**:
- `-d, --docs-dir <path>`: 文档目录路径（默认: docs）
- `-c, --code-dir <path>`: 代码目录路径（默认: core）

**示例**:
```bash
# 使用默认目录
node dist/index.js init

# 指定文档和代码目录
node dist/index.js init --docs-dir docs --code-dir core
```

**初始化过程**:
1. 扫描文档目录，查找所有 `.md` 文件
2. 扫描代码目录，查找所有 `.ts` 和 `.tsx` 文件
3. 根据文件名和目录结构自动生成映射规则
4. 验证映射规则的有效性
5. 创建配置文件 `.doc-code-mapping.json`

**配置文件示例**:
```json
{
  "version": "1.0",
  "mappings": [
    {
      "id": "mapping-001",
      "document": "docs/YYC3-PortAISys-智能浮窗/00-YYC3-PortAISys-AutonomousAIEngine实现文档.md",
      "codeFiles": [
        "core/autonomous-ai-widget/AutonomousAIEngine.ts",
        "core/autonomous-ai-widget/types.ts"
      ],
      "type": "one-to-many",
      "syncEnabled": true,
      "syncStatus": "pending"
    }
  ],
  "globalSettings": {
    "autoSync": true,
    "syncInterval": 300,
    "conflictResolution": "manual",
    "notificationEnabled": true
  }
}
```

### 2.2 启动文件监控

**命令**:
```bash
node dist/index.js watch [options]
```

**选项**:
- `-d, --docs-dir <path>`: 文档目录路径（默认: docs）
- `-c, --code-dir <path>`: 代码目录路径（默认: core）
- `-c, --config <path>`: 配置文件路径（默认: .doc-code-mapping.json）

**示例**:
```bash
# 使用默认配置
node dist/index.js watch

# 指定文档和代码目录
node dist/index.js watch --docs-dir docs --code-dir core

# 指定配置文件
node dist/index.js watch --config .doc-code-mapping.json
```

**监控输出示例**:
```
🚀 YYC³ 文档与代码双向同步工具
按 Ctrl+C 停止监控

📄 文档变更: docs/YYC3-PortAISys-智能浮窗/00-YYC3-PortAISys-AutonomousAIEngine实现文档.md
✅ 同步成功: 同步完成: 1 个映射
   - docs/YYC3-PortAISys-智能浮窗/00-YYC3-PortAISys-AutonomousAIEngine实现文档.md: 同步成功

💻 代码变更: core/AutonomousAIEngine.ts
✅ 同步成功: 同步完成: 1 个映射
   - docs/YYC3-PortAISys-智能浮窗/00-YYC3-PortAISys-AutonomousAIEngine实现文档.md: 同步成功
```

### 2.3 手动同步

**命令**:
```bash
node dist/index.js sync <file> [options]
```

**参数**:
- `<file>`: 要同步的文件路径

**选项**:
- `-c, --config <path>`: 配置文件路径（默认: .doc-code-mapping.json）

**示例**:
```bash
# 同步文档文件
node dist/index.js sync docs/YYC3-PortAISys-智能浮窗/00-YYC3-PortAISys-AutonomousAIEngine实现文档.md

# 同步代码文件
node dist/index.js sync core/AutonomousAIEngine.ts
```

**同步输出示例**:
```
✔ 同步完成: 1 个映射
   - docs/YYC3-PortAISys-智能浮窗/00-YYC3-PortAISys-AutonomousAIEngine实现文档.md: 同步成功
```

### 2.4 查看同步状态

**命令**:
```bash
node dist/index.js status [options]
```

**选项**:
- `-c, --config <path>`: 配置文件路径（默认: .doc-code-mapping.json）

**示例**:
```bash
node dist/index.js status
```

**状态输出示例**:
```
📊 同步状态

总映射数: 10
已同步: 8
失败: 1
最后同步时间: 2026-01-20T10:30:00.000Z

⏳ 待同步的映射:
   - mapping-003

❌ 失败的映射:
   - mapping-005
```

### 2.5 列出映射规则

**命令**:
```bash
node dist/index.js list [options]
```

**选项**:
- `-c, --config <path>`: 配置文件路径（默认: .doc-code-mapping.json）

**示例**:
```bash
node dist/index.js list
```

**列表输出示例**:
```
📋 映射规则列表 (10)

1. mapping-001
   文档: docs/YYC3-PortAISys-智能浮窗/00-YYC3-PortAISys-AutonomousAIEngine实现文档.md
   代码: core/autonomous-ai-widget/AutonomousAIEngine.ts, core/autonomous-ai-widget/types.ts
   类型: one-to-many
   状态: success
   同步: 启用
   最后同步: 2026-01-20T10:30:00.000Z

2. mapping-002
   文档: docs/YYC3-PortAISys-智能浮窗/00-YYC3-PortAISys-ModelAdapter实现文档.md
   代码: core/model/ModelAdapter.ts, core/model/types.ts
   类型: one-to-many
   状态: pending
   同步: 启用
```

### 2.6 添加映射规则

**命令**:
```bash
node dist/index.js add
```

**交互式输入示例**:
```
? 文档文件路径: docs/YYC3-PortAISys-智能浮窗/02-YYC3-PortAISys-智能浮窗-深度设计.md
? 代码文件路径 (多个文件用逗号分隔): core/state-manager/StateManager.ts, core/task-scheduler/TaskScheduler.ts
? 映射类型: one-to-many
? 启用同步: Yes

✅ 映射规则已添加: mapping-011
```

### 2.7 删除映射规则

**命令**:
```bash
node dist/index.js remove <id> [options]
```

**参数**:
- `<id>`: 映射 ID

**选项**:
- `-c, --config <path>`: 配置文件路径（默认: .doc-code-mapping.json）

**示例**:
```bash
node dist/index.js remove mapping-001
```

**交互式确认示例**:
```
? 确认删除映射 mapping-001? Yes
✅ 映射已删除: mapping-001
```

---

## 三、配置详解

### 3.1 映射规则配置

**映射规则结构**:
```json
{
  "id": "mapping-001",
  "document": "docs/YYC3-PortAISys-智能浮窗/00-YYC3-PortAISys-AutonomousAIEngine实现文档.md",
  "codeFiles": [
    "core/autonomous-ai-widget/AutonomousAIEngine.ts",
    "core/autonomous-ai-widget/types.ts"
  ],
  "type": "one-to-many",
  "syncEnabled": true,
  "lastSync": "2026-01-20T10:30:00.000Z",
  "syncStatus": "success"
}
```

**字段说明**:

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| id | string | 是 | 映射唯一标识符，格式: mapping-XXX |
| document | string | 是 | 文档文件路径（相对于项目根目录） |
| codeFiles | array | 是 | 代码文件路径数组（相对于项目根目录） |
| type | string | 是 | 映射类型：one-to-one、one-to-many、many-to-one |
| syncEnabled | boolean | 否 | 是否启用同步（默认: true） |
| lastSync | string | 否 | 最后同步时间（ISO 8601 格式） |
| syncStatus | string | 否 | 同步状态：success、failed、pending |

**映射类型说明**:

| 类型 | 说明 | 示例 |
|------|------|------|
| one-to-one | 一个文档对应一个代码文件 | 文档: A.md → 代码: A.ts |
| one-to-many | 一个文档对应多个代码文件 | 文档: A.md → 代码: A.ts, B.ts, C.ts |
| many-to-one | 多个文档对应一个代码文件 | 文档: A.md, B.md → 代码: A.ts |

### 3.2 全局设置配置

**全局设置结构**:
```json
{
  "globalSettings": {
    "autoSync": true,
    "syncInterval": 300,
    "conflictResolution": "manual",
    "notificationEnabled": true
  }
}
```

**字段说明**:

| 字段名 | 类型 | 必填 | 说明 | 默认值 |
|--------|------|------|------|--------|
| autoSync | boolean | 否 | 是否自动同步 | true |
| syncInterval | number | 否 | 同步间隔（秒） | 300 |
| conflictResolution | string | 否 | 冲突解决策略 | manual |
| notificationEnabled | boolean | 否 | 是否启用通知 | true |

**冲突解决策略说明**:

| 策略 | 说明 |
|------|------|
| manual | 手动解决冲突，需要用户介入 |
| auto | 自动解决冲突，使用算法自动合并 |
| latest | 采用最新的修改内容 |

---

## 四、同步机制说明

### 4.1 文档到代码同步

**同步内容**:
- 功能描述
- API 接口
- 使用示例

**同步方式**:
1. 提取文档中的关键信息
2. 更新代码文件的注释和文档字符串
3. 保留代码的实现逻辑不变

**文档示例**:
```markdown
# AutonomousAIEngine 实现文档

## 功能描述
AutonomousAIEngine 是一个自主 AI 引擎，负责管理 AI 系统的生命周期、消息处理和子系统管理。

## API 接口
- initialize(config: EngineConfig): Promise<void>
- start(): Promise<void>
- stop(): Promise<void>
```

**代码同步结果**:
```typescript
/**
 * AutonomousAIEngine 是一个自主 AI 引擎，负责管理 AI 系统的生命周期、消息处理和子系统管理。
 * 
 * API 接口:
 * - initialize(config: EngineConfig): Promise<void>
 * - start(): Promise<void>
 * - stop(): Promise<void>
 */
export class AutonomousAIEngine {
  // 代码实现
}
```

### 4.2 代码到文档同步

**同步内容**:
- 类名/接口名
- 方法列表
- 注释说明

**同步方式**:
1. 提取代码中的关键信息
2. 更新文档文件的相关章节
3. 保留文档的其他内容不变

**代码示例**:
```typescript
/**
 * StateManager 负责管理系统状态，提供状态持久化、快照和恢复功能。
 */
export class StateManager {
  /**
   * 获取当前状态
   */
  getState(): any {
    // 实现
  }

  /**
   * 设置状态
   */
  setState(newState: any): void {
    // 实现
  }
}
```

**文档同步结果**:
```markdown
# StateManager 实现文档

## 功能描述
StateManager 负责管理系统状态，提供状态持久化、快照和恢复功能。

## 方法列表
- `getState()`
- `setState(newState: any)`
```

### 4.3 冲突检测与解决

**冲突类型**:
1. **内容冲突**: 同一段落被文档和代码同时修改
2. **时间冲突**: 文档和代码在同一时间被修改
3. **格式冲突**: 文档和代码的格式不一致

**冲突解决策略**:

| 策略 | 说明 | 适用场景 |
|------|------|----------|
| manual | 手动解决冲突 | 复杂冲突，需要人工判断 |
| auto | 自动解决冲突 | 简单冲突，可以自动合并 |
| latest | 采用最新的修改 | 快速解决，但可能丢失部分修改 |

**冲突处理流程**:
```
1. 检测冲突
   - 比较文档和代码的修改时间
   - 检查修改内容是否冲突

2. 分析冲突
   - 确定冲突类型
   - 评估冲突严重程度

3. 解决冲突
   - 根据配置的策略解决冲突
   - 记录冲突解决结果

4. 通知用户
   - 发送冲突通知
   - 提供冲突详情
```

---

## 五、最佳实践

### 5.1 文档编写规范

**文档结构规范**:
```markdown
# 文档标题

## 功能描述
[功能描述内容]

## API 接口
[API 接口说明]

## 使用示例
[使用示例代码]

## 注意事项
[注意事项说明]
```

**文档命名规范**:
- 使用清晰的描述性名称
- 使用统一的命名前缀（如: 00-YYC3-PortAISys-）
- 使用连字符分隔单词
- 避免使用特殊字符

**示例**:
```
✅ 好的命名:
- 00-YYC3-PortAISys-AutonomousAIEngine实现文档.md
- 01-YYC3-PortAISys-智能浮窗-核心架构.md

❌ 不好的命名:
- doc.md
- 文档.md
- AutonomousAIEngine Doc.md
```

### 5.2 代码编写规范

**代码注释规范**:
```typescript
/**
 * 类/函数/方法的描述
 * 
 * @param paramName - 参数说明
 * @returns 返回值说明
 * @throws {Error} 错误说明
 */
export class ClassName {
  /**
   * 方法的描述
   * 
   * @param param - 参数说明
   * @returns 返回值说明
   */
  methodName(param: string): void {
    // 代码实现
  }
}
```

**代码命名规范**:
- 使用 PascalCase 命名类和接口
- 使用 camelCase 命名变量和函数
- 使用 kebab-case 命名目录
- 避免使用缩写

**示例**:
```typescript
// ✅ 好的命名
export class AutonomousAIEngine {
  private messageBus: MessageBus;
  
  async initialize(config: EngineConfig): Promise<void> {
    // 实现
  }
}

// ❌ 不好的命名
export class AIE {
  private mb: MB;
  
  async init(cfg: EC): Promise<void> {
    // 实现
  }
}
```

### 5.3 同步使用建议

**同步建议**:
1. **及时保存**: 编辑完成后及时保存文档和代码
2. **定期检查**: 定期检查同步状态和历史记录
3. **处理冲突**: 及时处理同步冲突
4. **更新映射**: 及时更新映射规则
5. **查看日志**: 定期查看同步日志

**工作流程**:
```
1. 开始编辑前
   - 检查同步状态
   - 拉取最新版本
   - 确认映射规则

2. 编辑过程中
   - 及时保存修改
   - 避免同时编辑文档和代码
   - 注意同步通知

3. 编辑完成后
   - 保存文件
   - 等待自动同步
   - 检查同步结果
```

---

## 六、故障排除

### 6.1 常见问题

**问题1: 同步失败**
- **错误信息**: `同步失败: 文件不存在`
- **原因**: 文件路径错误或文件被删除
- **解决方法**:
  1. 检查文件路径是否正确
  2. 确认文件是否存在
  3. 更新映射规则

**问题2: 映射规则无效**
- **错误信息**: `映射规则验证失败`
- **原因**: 映射规则配置错误
- **解决方法**:
  1. 检查映射规则配置文件
  2. 确认文件路径是否正确
  3. 重新初始化配置

**问题3: 监控不工作**
- **错误信息**: `监控服务未启动`
- **原因**: 文件监控服务未启动或崩溃
- **解决方法**:
  1. 重新启动监控服务
  2. 检查文件权限
  3. 查看日志文件

**问题4: 冲突无法解决**
- **错误信息**: `冲突解决失败`
- **原因**: 冲突解决策略配置不当
- **解决方法**:
  1. 调整冲突解决策略
  2. 手动解决冲突
  3. 检查文档和代码内容

### 6.2 日志查看

**日志文件位置**: `./sync-monitor.log`

**日志内容示例**:
```
[2026-01-20T10:30:00.000Z] 监控服务已启动
[2026-01-20T10:30:05.000Z] 同步结果: 成功 - 同步完成: 1 个映射
[2026-01-20T10:30:10.000Z] 告警: [error] 同步失败告警 - 检测到 5 个映射同步失败
```

**日志级别**:
- `INFO`: 一般信息
- `SUCCESS`: 成功操作
- `WARNING`: 警告信息
- `ERROR`: 错误信息

### 6.3 调试技巧

**启用调试模式**:
```bash
# 设置环境变量启用调试
export DEBUG=yyc3-doc-sync:*
node dist/index.js watch
```

**查看详细日志**:
```bash
# 查看同步日志
tail -f sync-monitor.log

# 查看错误日志
grep ERROR sync-monitor.log
```

**手动测试同步**:
```bash
# 手动同步单个文件
node dist/index.js sync docs/YYC3-PortAISys-智能浮窗/00-YYC3-PortAISys-AutonomousAIEngine实现文档.md

# 查看同步结果
node dist/index.js status
```

---

## 七、高级功能

### 7.1 自定义同步规则

**自定义提取规则**:
```typescript
// 在 sync-trigger.ts 中自定义提取规则
private extractCodeInfoFromDoc(docContent: string): any {
  const info: any = {};

  // 自定义提取规则
  const customMatch = docContent.match(/## 自定义章节\s*\n([\s\S]*?)(?=\n##|$)/);
  if (customMatch) {
    info.custom = customMatch[1].trim();
  }

  return info;
}
```

### 7.2 集成 CI/CD

**GitHub Actions 示例**:
```yaml
name: Doc-Code Sync

on:
  push:
    paths:
      - 'docs/**/*.md'
      - 'core/**/*.ts'

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Setup Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '18'
      - name: Install dependencies
        run: |
          cd tools/doc-code-sync
          npm install
          npm run build
      - name: Run sync
        run: |
          cd tools/doc-code-sync
          node dist/index.js sync ${{ github.event.path }}
      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git commit -m "docs: 自动同步文档和代码"
          git push
```

### 7.3 多环境配置

**多环境配置示例**:
```json
{
  "version": "1.0",
  "environments": {
    "development": {
      "autoSync": true,
      "syncInterval": 60,
      "notificationEnabled": true
    },
    "production": {
      "autoSync": false,
      "syncInterval": 600,
      "notificationEnabled": true
    }
  },
  "currentEnvironment": "development",
  "mappings": []
}
```

---

## 八、总结

本文档详细说明了 YYC³ PortAISys 文档同步机制的使用方法，包括：

1. **快速开始**: 安装与初始化、启动监控
2. **详细使用指南**: 初始化配置、启动文件监控、手动同步、查看同步状态、列出映射规则、添加映射规则、删除映射规则
3. **配置详解**: 映射规则配置、全局设置配置
4. **同步机制说明**: 文档到代码同步、代码到文档同步、冲突检测与解决
5. **最佳实践**: 文档编写规范、代码编写规范、同步使用建议
6. **故障排除**: 常见问题、日志查看、调试技巧
7. **高级功能**: 自定义同步规则、集成 CI/CD、多环境配置

通过这个文档同步机制，可以确保文档与代码的清晰关联，支持文档与代码的双向同步，实现文档与代码的版本一致性，提供文档与代码的变更追踪能力，确保文档与代码的实时同步。

---

**文档结束**
