name: Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  snyk-security:
    name: Snyk Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run Snyk to check for vulnerabilities
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=medium --org=yyc3-team --project-name=yyc3-portaisys
      
      - name: Upload Snyk results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: snyk.sarif

  npm-audit:
    name: NPM Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run npm audit
        run: npm audit --audit-level=moderate
        continue-on-error: true
      
      - name: Run npm audit fix
        run: npm audit fix
        continue-on-error: true

  owasp-zap-scan:
    name: OWASP ZAP Scan
    runs-on: ubuntu-latest
    needs: [snyk-security, npm-audit]
    
    services:
      app:
        image: node:18
        ports:
          - 3200:3200
        options: >-
          --health-cmd "curl -f http://localhost:3200/health || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build application
        run: npm run build
        continue-on-error: true
      
      - name: Start application
        run: npm run dev &
        continue-on-error: true
      
      - name: Wait for application to be ready
        run: |
          for i in {1..30}; do
            if curl -f http://localhost:3200/health; then
              echo "Application is ready"
              break
            fi
            echo "Waiting for application... ($i/30)"
            sleep 2
          done
      
      - name: Run OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.10.0
        with:
          target: 'http://localhost:3200'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'
        continue-on-error: true
      
      - name: Upload ZAP Report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: zap-report
          path: report_html.html
      
      - name: Upload ZAP SARIF
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: zap_report.sarif

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [snyk-security, npm-audit, owasp-zap-scan]
    if: always()
    
    steps:
      - name: Download Snyk SARIF
        uses: actions/download-artifact@v3
        with:
          name: snyk-sarif
        continue-on-error: true
      
      - name: Download ZAP Report
        uses: actions/download-artifact@v3
        with:
          name: zap-report
        continue-on-error: true
      
      - name: Generate Security Summary
        run: |
          echo "# Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "- Snyk Security: ${{ needs.snyk-security.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- NPM Audit: ${{ needs.npm-audit.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- OWASP ZAP Scan: ${{ needs.owasp-zap-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Recommendations" >> $GITHUB_STEP_SUMMARY
          echo "1. Review all security findings" >> $GITHUB_STEP_SUMMARY
          echo "2. Fix critical and high severity vulnerabilities" >> $GITHUB_STEP_SUMMARY
          echo "3. Update dependencies to secure versions" >> $GITHUB_STEP_SUMMARY
          echo "4. Implement security best practices" >> $GITHUB_STEP_SUMMARY
